<div class="charMemory_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Character Memory</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">

            <!-- Stats bar â€” always visible -->
            <div class="charMemory_statsBar">
                <div class="charMemory_statItem" title="The Data Bank file where memories are stored for this character">
                    <i class="fa-solid fa-file-lines fa-sm"></i>
                    <span id="charMemory_statFile">No character</span>
                </div>
                <div class="charMemory_statItem" title="Total number of individual memory bullets stored">
                    <i class="fa-solid fa-brain fa-sm"></i>
                    <span id="charMemory_statCount">0 memories</span>
                </div>
                <div class="charMemory_statItem" title="New messages since last extraction / auto-extraction threshold. When this fills up, extraction triggers automatically.">
                    <i class="fa-solid fa-arrows-rotate fa-sm"></i>
                    <span id="charMemory_statProgress">0/10 msgs</span>
                </div>
                <div class="charMemory_statItem" title="Time remaining before the next auto-extraction is allowed. Manual extractions bypass this.">
                    <i class="fa-solid fa-clock fa-sm"></i>
                    <span id="charMemory_statCooldown">Ready</span>
                </div>
            </div>

            <div class="charMemory_statusRow">
                <label class="checkbox_label" for="charMemory_enabled" title="When enabled, memories are extracted automatically after a set number of new messages">
                    <input type="checkbox" id="charMemory_enabled" />
                    <span>Enable automatic extraction</span>
                </label>
            </div>

            <div class="charMemory_buttonRow">
                <input type="button" id="charMemory_extractNow" class="menu_button" value="Extract Now" title="Extract memories from unprocessed messages. If all messages have been processed, use 'Reset Extraction State' first to re-read from the beginning." />
                <input type="button" id="charMemory_manageMemories" class="menu_button" value="View / Edit" title="Browse, edit, and delete individual stored memories" />
                <input type="button" id="charMemory_consolidate" class="menu_button" value="Consolidate" title="Use the LLM to merge duplicate and related memories into fewer, cleaner entries" />
                <input type="button" id="charMemory_undoConsolidate" class="menu_button" value="Undo Consolidation" title="Restore memories from before the last consolidation (session only)" disabled />
            </div>

            <!-- Settings (default closed) -->
            <div class="inline-drawer">
                <div class="inline-drawer-toggle inline-drawer-header">
                    <b>Settings</b>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content">

                    <!-- Section 1: LLM Provider -->
                    <div class="charMemory_statusRow">
                        <label for="charMemory_source" title="Which LLM provider to use for memory extraction and consolidation">
                            <small>LLM Provider</small>
                        </label>
                        <select id="charMemory_source" class="text_pole">
                            <option value="main_llm">Main LLM</option>
                            <option value="webllm">WebLLM (browser-local)</option>
                            <option value="provider">API Provider (recommended)</option>
                        </select>
                        <small class="charMemory_helperText"><b>API Provider is recommended.</b> Main LLM pollutes the extraction prompt with chat context, system prompts, and other instructions that degrade memory quality. API Provider sends a clean, focused extraction prompt directly to the LLM.</small>

                        <div id="charMemory_providerSettings" style="display:none;">
                            <div class="charMemory_statusRow">
                                <label><small>Provider</small></label>
                                <select id="charMemory_providerSelect" class="text_pole">
                                </select>
                            </div>
                            <div class="charMemory_statusRow" id="charMemory_providerApiKeyRow">
                                <label><small>API Key <a id="charMemory_providerHelpLink" href="#" target="_blank" style="font-size:0.85em;">(get key)</a></small></label>
                                <div style="display:flex;gap:5px;align-items:center;">
                                    <input type="password" id="charMemory_providerApiKey" class="text_pole" placeholder="Enter API key" style="flex:1;" />
                                    <input type="button" id="charMemory_providerTest" class="menu_button" value="Test" title="Send a minimal request to verify your API key works" />
                                </div>
                            </div>
                            <div class="charMemory_statusRow" id="charMemory_providerBaseUrlRow" style="display:none;">
                                <label><small>Base URL</small></label>
                                <input type="text" id="charMemory_providerBaseUrl" class="text_pole" placeholder="https://your-server.com/v1" />
                            </div>
                            <div class="charMemory_statusRow" id="charMemory_providerModelDropdownRow">
                                <label><small>Model</small></label>
                                <div id="charMemory_nanogptFilters" style="display:none;">
                                    <div class="charMemory_filterRow" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">
                                        <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterSub" /> <small>Subscription</small></label>
                                        <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterOS" /> <small>Open Source</small></label>
                                        <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterRP" /> <small>Roleplay</small></label>
                                        <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterReasoning" /> <small>Reasoning</small></label>
                                    </div>
                                </div>
                                <div style="display:flex;gap:5px;align-items:center;">
                                    <select id="charMemory_providerModel" class="text_pole" style="flex:1;">
                                        <option value="">-- Select model --</option>
                                    </select>
                                    <input type="button" id="charMemory_providerRefreshModels" class="menu_button" value="&#x21bb;" title="Refresh model list" />
                                </div>
                                <small id="charMemory_providerModelInfo" class="charMemory_helperText"></small>
                            </div>
                            <div class="charMemory_statusRow" id="charMemory_providerModelInputRow" style="display:none;">
                                <label><small>Model ID</small></label>
                                <input type="text" id="charMemory_providerModelInput" class="text_pole" placeholder="Enter model identifier" />
                                <small class="charMemory_helperText">Enter the model ID manually (e.g. claude-sonnet-4-5-20250929).</small>
                            </div>
                            <div class="charMemory_statusRow">
                                <label><small>System prompt (optional)</small></label>
                                <textarea id="charMemory_providerSystemPrompt" class="text_pole" rows="3" placeholder="Override the default system prompt. Leave blank for default."></textarea>
                                <small class="charMemory_helperText">Prepended to extraction/consolidation calls. Use for jailbreaks or custom instructions.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Auto-Extraction -->
                    <hr class="charMemory_separator" />
                    <small><b>Auto-Extraction</b></small>

                    <div class="charMemory_sliderRow">
                        <label title="How many new messages trigger an automatic extraction. Only counts messages received after the last extraction.">
                            <small>Extract after every N messages</small>
                        </label>
                        <input class="neo-range-slider" type="range" id="charMemory_interval" min="3" max="100" step="1" value="20" />
                        <div class="wide100p">
                            <input class="neo-range-input" type="number" min="3" max="100" step="1"
                                   data-for="charMemory_interval" id="charMemory_intervalCounter" />
                        </div>
                    </div>

                    <div class="charMemory_sliderRow">
                        <label title="Minimum time between auto-extractions, even if the message threshold is met. Prevents rapid-fire extractions. Manual 'Extract Now' bypasses this.">
                            <small>Minimum wait between extractions (min)</small>
                        </label>
                        <input class="neo-range-slider" type="range" id="charMemory_minCooldown" min="0" max="30" step="1" value="10" />
                        <div class="wide100p">
                            <input class="neo-range-input" type="number" min="0" max="30" step="1"
                                   data-for="charMemory_minCooldown" id="charMemory_minCooldownCounter" />
                        </div>
                    </div>

                    <small class="charMemory_helperText">These settings only affect automatic extraction. Manual extraction and batch extraction ignore them.</small>

                    <!-- Section 3: Extraction Settings -->
                    <hr class="charMemory_separator" />
                    <small><b>Extraction Settings</b></small>

                    <div class="charMemory_sliderRow">
                        <label title="How many messages to include in each LLM call. The system loops through all unprocessed messages in chunks of this size.">
                            <small>Messages per LLM call</small>
                        </label>
                        <input class="neo-range-slider" type="range" id="charMemory_maxMessages" min="10" max="200" step="1" value="50" />
                        <div class="wide100p">
                            <input class="neo-range-input" type="number" min="10" max="200" step="1"
                                   data-for="charMemory_maxMessages" id="charMemory_maxMessagesCounter" />
                        </div>
                    </div>

                    <div class="charMemory_sliderRow">
                        <label title="Maximum tokens the LLM can use for its response. Increase if extractions seem truncated.">
                            <small>Max response length</small>
                        </label>
                        <input class="neo-range-slider" type="range" id="charMemory_responseLength" min="100" max="2000" step="50" value="1000" />
                        <div class="wide100p">
                            <input class="neo-range-input" type="number" min="100" max="2000" step="50"
                                   data-for="charMemory_responseLength" id="charMemory_responseLengthCounter" />
                        </div>
                    </div>

                    <!-- Section 4: Storage -->
                    <hr class="charMemory_separator" />

                    <div class="charMemory_statusRow">
                        <label class="checkbox_label" for="charMemory_perChat" title="When enabled, each chat gets its own memory file. When disabled, all chats for a character share one file.">
                            <input type="checkbox" id="charMemory_perChat" />
                            <span>Separate memories per chat</span>
                        </label>
                        <small class="charMemory_helperText">Each conversation gets its own memory file instead of sharing one per character.</small>
                    </div>

                    <div class="charMemory_statusRow">
                        <label for="charMemory_fileName" title="Override the auto-generated file name. Leave blank to use the default (based on character name).">
                            <small>File name override</small>
                        </label>
                        <input type="text" id="charMemory_fileName" class="text_pole" placeholder="(auto-generated from character name)" />
                        <small class="charMemory_helperText">Leave blank for auto-naming. Set a custom name to override.</small>
                    </div>

                    <!-- Section 5: Advanced -->
                    <hr class="charMemory_separator" />

                    <div class="charMemory_promptSection">
                        <label for="charMemory_extractionPrompt" title="The prompt sent to the LLM for memory extraction. Uses {{charName}}, {{charCard}}, {{existingMemories}}, {{recentMessages}}, {{char}}, and {{user}} placeholders.">
                            <small>Extraction prompt</small>
                        </label>
                        <textarea id="charMemory_extractionPrompt" class="text_pole textarea_compact" rows="8" placeholder="Enter extraction prompt..."></textarea>
                        <input type="button" id="charMemory_restorePrompt" class="menu_button" value="Restore Default Prompt" title="Replace the current prompt with the built-in default" />
                    </div>

                    <hr class="charMemory_separator" />

                    <div class="charMemory_statusRow">
                        <input type="button" id="charMemory_resetTracking" class="menu_button" value="Reset Extraction State" title="Reset extraction tracking for the current character's chats so all messages can be re-processed. Does not delete any memories." />
                        <small class="charMemory_helperText">Resets extraction tracking for the current character (active chat + batch state). Use before 'Extract Now' or 'Batch Extract' to re-process from the beginning. Does not affect other characters.</small>
                        <input type="button" id="charMemory_resetExtraction" class="menu_button charMemory_dangerBtn" value="Clear All Memories" title="Delete the memory file and reset extraction state for the current character. This cannot be undone." />
                        <small class="charMemory_helperText">Deletes the memory file and resets extraction tracking for the current character. In default mode, this file contains memories from all of this character's chats. This cannot be undone.</small>
                    </div>
                </div>
            </div>

            <!-- Tools & Diagnostics (tabbed, default closed) -->
            <div class="inline-drawer">
                <div class="inline-drawer-toggle inline-drawer-header">
                    <b>Tools &amp; Diagnostics</b>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content">
                    <div class="charMemory_tabs">
                        <button class="charMemory_tab" data-tab="batch">Batch Extract</button>
                        <button class="charMemory_tab active" data-tab="log">Activity Log</button>
                        <button class="charMemory_tab" data-tab="diag">Diagnostics</button>
                    </div>
                    <div class="charMemory_tabContent" id="charMemory_tabBatch" style="display:none;">
                        <div class="charMemory_buttonRow">
                            <input type="button" id="charMemory_batchRefresh" class="menu_button" value="Refresh" title="Load chat list for this character" />
                            <input type="button" id="charMemory_batchExtract" class="menu_button" value="Extract Selected" title="Run extraction on all selected chats" disabled />
                            <input type="button" id="charMemory_batchStop" class="menu_button" value="Stop" title="Cancel batch extraction" style="display:none;" />
                        </div>
                        <div class="charMemory_batchSelectRow">
                            <label class="checkbox_label">
                                <input type="checkbox" id="charMemory_batchSelectAll" />
                                <small>Select all</small>
                            </label>
                        </div>
                        <div id="charMemory_batchProgress" class="charMemory_batchProgress" style="display:none;">
                            <div class="charMemory_batchProgressText"></div>
                            <div class="charMemory_batchProgressBar"><div class="charMemory_batchProgressFill"></div></div>
                        </div>
                        <div id="charMemory_batchChatList" class="charMemory_batchChatList">
                            <div class="charMemory_diagEmpty">Click "Refresh" to load chats.</div>
                        </div>
                    </div>
                    <div class="charMemory_tabContent" id="charMemory_tabLog">
                        <div class="charMemory_buttonRow">
                            <input type="button" id="charMemory_clearLog" class="menu_button" value="Clear" title="Clear the activity log" />
                            <input type="button" id="charMemory_saveLog" class="menu_button" value="Save Log" title="Download the activity log as a text file" />
                            <label class="checkbox_label" for="charMemory_verboseLog" title="Show full LLM prompts and responses in the activity log">
                                <input type="checkbox" id="charMemory_verboseLog" />
                                <small>Verbose</small>
                            </label>
                        </div>
                        <div id="charMemory_activityLog" class="charMemory_activityLog" style="max-height:300px;overflow-y:auto;font-size:0.85em;font-family:monospace;">
                            <div class="charMemory_diagEmpty">No activity yet.</div>
                        </div>
                    </div>
                    <div class="charMemory_tabContent" id="charMemory_tabDiag" style="display:none;">
                        <div class="charMemory_buttonRow">
                            <input type="button" id="charMemory_refreshDiag" class="menu_button" value="Refresh" title="Capture current diagnostics (lorebook entries, extension prompts, memory file status)" />
                        </div>
                        <div id="charMemory_diagnosticsContent" class="charMemory_diagnosticsContent">
                            <div class="charMemory_diagEmpty">Click "Refresh" after a generation to see diagnostics.</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
