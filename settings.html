<div class="charMemory_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Character Memory</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">

            <!-- Stats bar â€” always visible -->
            <div class="charMemory_statsBar">
                <div class="charMemory_statItem">
                    <i class="fa-solid fa-file-lines fa-sm"></i>
                    <span id="charMemory_statFile" title="Active memory file">No character</span>
                </div>
                <div class="charMemory_statItem">
                    <i class="fa-solid fa-brain fa-sm"></i>
                    <span id="charMemory_statCount" title="Stored memories">0 memories</span>
                </div>
                <div class="charMemory_statItem">
                    <i class="fa-solid fa-arrows-rotate fa-sm"></i>
                    <span id="charMemory_statProgress" title="Extraction progress">0/10 msgs</span>
                </div>
                <div class="charMemory_statItem">
                    <i class="fa-solid fa-clock fa-sm"></i>
                    <span id="charMemory_statCooldown" title="Cooldown status">Ready</span>
                </div>
            </div>

            <div class="charMemory_statusRow">
                <label class="checkbox_label" for="charMemory_enabled">
                    <input type="checkbox" id="charMemory_enabled" />
                    <span>Enable automatic extraction</span>
                </label>
            </div>

            <div class="charMemory_buttonRow">
                <input type="button" id="charMemory_extractNow" class="menu_button" value="Extract Now" title="Run memory extraction on recent messages" />
                <input type="button" id="charMemory_manageMemories" class="menu_button" value="View / Edit" title="Browse and edit stored memories" />
                <input type="button" id="charMemory_consolidate" class="menu_button" value="Consolidate" title="Merge duplicate and related memories" />
                <input type="button" id="charMemory_undoConsolidate" class="menu_button" value="Undo Consolidation" title="Restore memories from before the last consolidation" disabled />
            </div>

            <div class="charMemory_sliderRow">
                <label for="charMemory_interval">
                    <small>Extract every <span id="charMemory_intervalValue">10</span> messages</small>
                </label>
                <input type="range" id="charMemory_interval" min="3" max="50" step="1" value="10" />
            </div>

            <div class="charMemory_sliderRow">
                <label for="charMemory_minCooldown">
                    <small>Min. cooldown: <span id="charMemory_minCooldownValue">10</span> min</small>
                </label>
                <input type="range" id="charMemory_minCooldown" min="0" max="30" step="1" value="10" />
            </div>

            <!-- Settings (default closed) -->
            <div class="inline-drawer">
                <div class="inline-drawer-toggle inline-drawer-header">
                    <b>Settings</b>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content">
                    <div class="charMemory_statusRow">
                        <label for="charMemory_source">
                            <small>Extraction source</small>
                        </label>
                        <select id="charMemory_source" class="text_pole">
                            <option value="main_llm">Main LLM</option>
                            <option value="webllm">WebLLM (browser-local)</option>
                            <option value="nanogpt">NanoGPT (direct API)</option>
                        </select>

                        <div id="charMemory_nanogptSettings" style="display:none;">
                            <div class="charMemory_statusRow">
                                <label><small>NanoGPT API Key</small></label>
                                <div style="display:flex;gap:5px;align-items:center;">
                                    <input type="password" id="charMemory_nanogptApiKey" class="text_pole" placeholder="Enter API key" style="flex:1;" />
                                    <input type="button" id="charMemory_nanogptTest" class="menu_button" value="Test" title="Test API connection" />
                                </div>
                            </div>
                            <div class="charMemory_statusRow">
                                <label><small>Model</small></label>
                                <div class="charMemory_filterRow" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">
                                    <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterSub" /> <small>Subscription</small></label>
                                    <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterOS" /> <small>Open Source</small></label>
                                    <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterRP" /> <small>Roleplay</small></label>
                                    <label class="checkbox_label"><input type="checkbox" id="charMemory_nanogptFilterReasoning" /> <small>Reasoning</small></label>
                                </div>
                                <select id="charMemory_nanogptModel" class="text_pole">
                                    <option value="">-- Select model --</option>
                                </select>
                                <small id="charMemory_nanogptModelInfo" class="charMemory_helperText"></small>
                            </div>
                            <div class="charMemory_statusRow">
                                <label><small>System prompt (optional)</small></label>
                                <textarea id="charMemory_nanogptSystemPrompt" class="text_pole" rows="3" placeholder="Override the default system prompt. Leave blank for default."></textarea>
                                <small class="charMemory_helperText">Prepended to extraction/consolidation calls. Use for jailbreaks or custom instructions.</small>
                            </div>
                        </div>
                    </div>

                    <div class="charMemory_sliderRow">
                        <label for="charMemory_maxMessages">
                            <small>Max messages per extraction: <span id="charMemory_maxMessagesValue">20</span></small>
                        </label>
                        <input type="range" id="charMemory_maxMessages" min="5" max="50" step="1" value="20" />
                    </div>

                    <div class="charMemory_sliderRow">
                        <label for="charMemory_responseLength">
                            <small>Response length (tokens): <span id="charMemory_responseLengthValue">500</span></small>
                        </label>
                        <input type="range" id="charMemory_responseLength" min="100" max="2000" step="50" value="500" />
                    </div>

                    <hr class="charMemory_separator" />

                    <div class="charMemory_statusRow">
                        <label class="checkbox_label" for="charMemory_perChat">
                            <input type="checkbox" id="charMemory_perChat" />
                            <span>Separate memories per chat</span>
                        </label>
                        <small class="charMemory_helperText">Each conversation gets its own memory file instead of sharing one per character.</small>
                    </div>

                    <div class="charMemory_statusRow">
                        <label for="charMemory_fileName">
                            <small>File name override</small>
                        </label>
                        <input type="text" id="charMemory_fileName" class="text_pole" placeholder="(auto-generated from character name)" />
                        <small class="charMemory_helperText">Leave blank for auto-naming. Set a custom name to override.</small>
                    </div>

                    <hr class="charMemory_separator" />

                    <div class="charMemory_promptSection">
                        <label for="charMemory_extractionPrompt">
                            <small>Extraction prompt</small>
                        </label>
                        <textarea id="charMemory_extractionPrompt" class="text_pole textarea_compact" rows="8" placeholder="Enter extraction prompt..."></textarea>
                        <input type="button" id="charMemory_restorePrompt" class="menu_button" value="Restore Default Prompt" />
                    </div>

                    <hr class="charMemory_separator" />

                    <div class="charMemory_statusRow">
                        <input type="button" id="charMemory_resetTracking" class="menu_button" value="Reset Extraction State" title="Reset extraction tracking so the next extraction re-reads all messages" />
                        <small class="charMemory_helperText">Resets extraction tracking without deleting memories. Use after editing or deleting memories so the LLM can re-extract from earlier messages.</small>
                        <input type="button" id="charMemory_resetExtraction" class="menu_button charMemory_dangerBtn" value="Clear All Memories" title="Delete all memories and reset extraction state" />
                        <small class="charMemory_helperText">Deletes the memory file and resets extraction tracking. This cannot be undone.</small>
                    </div>
                </div>
            </div>

            <!-- Activity & Diagnostics (tabbed, default closed) -->
            <div class="inline-drawer">
                <div class="inline-drawer-toggle inline-drawer-header">
                    <b>Activity &amp; Diagnostics</b>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content">
                    <div class="charMemory_tabs">
                        <button class="charMemory_tab active" data-tab="log">Activity Log</button>
                        <button class="charMemory_tab" data-tab="diag">Diagnostics</button>
                    </div>
                    <div class="charMemory_tabContent" id="charMemory_tabLog">
                        <div class="charMemory_buttonRow">
                            <input type="button" id="charMemory_clearLog" class="menu_button" value="Clear" />
                        </div>
                        <div id="charMemory_activityLog" class="charMemory_activityLog" style="max-height:300px;overflow-y:auto;font-size:0.85em;font-family:monospace;">
                            <div class="charMemory_diagEmpty">No activity yet.</div>
                        </div>
                    </div>
                    <div class="charMemory_tabContent" id="charMemory_tabDiag" style="display:none;">
                        <div class="charMemory_buttonRow">
                            <input type="button" id="charMemory_refreshDiag" class="menu_button" value="Refresh" />
                        </div>
                        <div id="charMemory_diagnosticsContent" class="charMemory_diagnosticsContent">
                            <div class="charMemory_diagEmpty">Click "Refresh" after a generation to see diagnostics.</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
